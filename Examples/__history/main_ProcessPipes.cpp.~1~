#include <iostream>
#include <algorithm>

#include "Process/Process.h"
#include "Console.h"
#include "IOStream.h"

int main(int argc, char *argv[])
{
  using namespace std;
  namespace Bi= Bicycle;

  Bi::Console::setTextAttr(Bi::ConsoleColor::lime);

  if(argc>0 && strcmp(argv[0],"-echo")==0)
  {
    string line;
    while(getline(cin,line))
    {
      std::reverse(line.begin(),line.end());
      cout<<">"<<line<<endl;
    }
  }
  else
  {
    try
    {
      Bi::Process process;

      process.setInheritHandle(true);
      process.setSecurityInheritHandle(true);
      process.usePipes(true);
      process.setCmdLine(Bi::appModuleFileName()+ L" -echo");
      process.start();

      Bi::IOStream inStream(&process.stdIn());
      Bi::IOStream outStream(&process.stdOut());

      string line;
      while(getline(cin,line))
      {
        inStream.writeLn(line);
        line= outStream.readLn();
        cout<< line << endl;
      }
    }
    catch(const Bi::SystemException& e)
    {
      Bi::Console::changeCp(Bi::Win1251);
      Bi::Console::setTextAttr(Bi::ConsoleColor::red);
      cerr<< e.code()<<endl;
    }
  }

  getchar();
  return 0;
}


